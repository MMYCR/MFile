    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <title>åå°ç®¡ç† - å­˜å‚¨æºè®¾ç½®</title>
        <style>
            body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f5f7fa; }
            .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            h2, h3 { color: #333; }

            /* è¡¨æ ¼æ ·å¼ */
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
            th { background-color: #fafafa; font-weight: 600; }

            /* æŒ‰é’®æ ·å¼ */
            .btn { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; color: white; margin-right: 5px; font-size: 14px; }
            .btn-primary { background-color: #007bff; }
            .btn-danger { background-color: #dc3545; }
            .btn-edit { background-color: #28a745; }
            .btn:hover { opacity: 0.9; }

            /* è¡¨å•æ ·å¼ */
            .form-area { display: none; margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; background: #fdfdfd; padding: 20px; border-radius: 4px; }
            .form-group { margin-bottom: 15px; }
            .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
            .form-group input, .form-group select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
            .form-row { display: flex; gap: 20px; }
            .form-row .form-group { flex: 1; }

            .back-link { display: inline-block; margin-bottom: 15px; color: #666; text-decoration: none; }
            .back-link:hover { color: #007bff; }
        </style>
    </head>
    <body>

    <div class="container">
        <a href="/index.html" class="back-link">â† è¿”å›ç½‘ç›˜é¦–é¡µ</a>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>âš™ï¸ å­˜å‚¨æºç®¡ç†</h2>
            <button class="btn btn-primary" onclick="showForm()">+ æ–°å¢å­˜å‚¨æº</button>
        </div>

        <!-- åˆ—è¡¨åŒºåŸŸ -->
        <table id="storageTable">
            <thead>
            <tr>
                <th style="width: 50px">ID</th>
                <th>åç§°</th>
                <th>ç±»å‹</th>
                <th>åˆ«å(Key)</th>
                <th>è·¯å¾„/Bucket</th>
                <th style="width: 150px">æ“ä½œ</th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>

        <!-- ç¼–è¾‘/æ–°å¢ è¡¨å•åŒºåŸŸ -->
        <div id="formArea" class="form-area">
            <h3 id="formTitle">æ–°å¢/ç¼–è¾‘</h3>
            <input type="hidden" id="storageId">

            <div class="form-row">
                <div class="form-group">
                    <label>å­˜å‚¨æºåç§°</label>
                    <input type="text" id="name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„é˜¿é‡Œäº‘ç›˜">
                </div>
                <div class="form-group">
                    <label>å­˜å‚¨ç±»å‹</label>
                    <!-- ğŸŸ¢ æ ¸å¿ƒï¼šç±»å‹é€‰æ‹©å™¨ -->
                    <select id="type" onchange="toggleTypeFields()">
                        <option value="local">æœ¬åœ°å­˜å‚¨</option>
                        <option value="aliyun">é˜¿é‡Œäº‘ OSS</option>
                        <!-- <option value="tencent">è…¾è®¯äº‘ COS</option> -->
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>URL åˆ«å (Key)</label>
                    <input type="text" id="key" placeholder="ä¾‹å¦‚ï¼šaliyun (ç”¨äºæµè§ˆå™¨åœ°å€æ )">
                </div>
                <div class="form-group">
                    <label>æ’åºå·</label>
                    <input type="number" id="orderNum" value="0">
                </div>
            </div>

            <!-- ğŸŸ¢ åŠ¨æ€åŒºåŸŸ Aï¼šæœ¬åœ°å­˜å‚¨å‚æ•° -->
            <div id="localFields">
                <div class="form-group">
                    <label>æœ¬åœ°æ ¹ç›®å½•è·¯å¾„</label>
                    <input type="text" id="rootPath" placeholder="ä¾‹å¦‚ï¼šD:/Movies">
                </div>
            </div>

            <!-- ğŸŸ¢ åŠ¨æ€åŒºåŸŸ Bï¼šå¯¹è±¡å­˜å‚¨å‚æ•° (é»˜è®¤éšè—) -->
            <div id="s3Fields" style="display: none; background: #f0f7ff; padding: 15px; border-radius: 4px;">
                <div class="form-group">
                    <label>Endpoint (åœ°åŸŸèŠ‚ç‚¹)</label>
                    <input type="text" id="s3Endpoint" placeholder="ä¾‹å¦‚ï¼šoss-cn-shanghai.aliyuncs.com">
                </div>
                <div class="form-group">
                    <label>Bucket Name (æ¡¶åç§°)</label>
                    <input type="text" id="s3Bucket" placeholder="ä¾‹å¦‚ï¼šmy-zfile-drive">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>AccessKey ID</label>
                        <input type="text" id="s3Ak" placeholder="RAM å­è´¦å· AK">
                    </div>
                    <div class="form-group">
                        <label>AccessKey Secret</label>
                        <input type="text" id="s3Sk" placeholder="RAM å­è´¦å· SK">
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveStorage()">ä¿å­˜é…ç½®</button>
                <button class="btn" style="background:#666" onclick="hideForm()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // 1. æ‹¦æˆªå™¨ (å¤ç”¨ä¹‹å‰çš„ï¼Œå¸¦ Token)
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            const token = localStorage.getItem('satoken');
            options = options || {};
            options.headers = options.headers || {};
            if (token) {
                if (options.headers instanceof Headers) options.headers.append('satoken', token);
                else options.headers['satoken'] = token;
            }
            // é»˜è®¤å‘ JSON
            if (!options.headers['Content-Type'] && (!options.method || options.method !== 'GET')) {
                options.headers['Content-Type'] = 'application/json';
            }
            return originalFetch(url, options).then(res => {
                if (res.status === 401) {
                    location.href = '/login.html';
                    return Promise.reject("æœªç™»å½•");
                }
                return res;
            });
        };

        window.onload = loadList;

        // 2. åŠ è½½åˆ—è¡¨
        function loadList() {
            fetch('/api/admin/storage/list')
                .then(res => res.json())
                .then(res => {
                    const tbody = document.getElementById('tbody');
                    tbody.innerHTML = '';
                    res.data.forEach(item => {
                        // è§£æä¸€ä¸‹ configData ä¸ºäº†å±•ç¤º Bucket å
                        let displayPath = item.rootPath;
                        if (item.type === 'aliyun' && item.configData) {
                            try {
                                const conf = JSON.parse(item.configData);
                                displayPath = `[Bucket] ${conf.bucketName}`;
                            } catch(e){}
                        }

                        tbody.innerHTML += `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.name}</td>
                                <td><span style="background:#eee; padding:2px 6px; border-radius:3px; font-size:12px">${item.type}</span></td>
                                <td>${item.key}</td>
                                <td>${displayPath || '-'}</td>
                                <td>
                                    <button class="btn btn-edit" onclick="editStorage(${item.id})">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" onclick="delStorage(${item.id})">åˆ é™¤</button>
                                </td>
                            </tr>
                        `;
                    });
                });
        }

        // 3. åˆ‡æ¢è¡¨å•æ˜¾ç¤º (æœ¬åœ° vs S3)
        function toggleTypeFields() {
            const type = document.getElementById('type').value;
            if (type === 'local') {
                document.getElementById('localFields').style.display = 'block';
                document.getElementById('s3Fields').style.display = 'none';
            } else {
                document.getElementById('localFields').style.display = 'none';
                document.getElementById('s3Fields').style.display = 'block';
            }
        }

        function showForm() {
            document.getElementById('formArea').style.display = 'block';
            document.getElementById('storageId').value = '';
            document.getElementById('formTitle').innerText = 'æ–°å¢å­˜å‚¨æº';

            // æ¸…ç©ºè¡¨å•
            document.getElementById('name').value = '';
            document.getElementById('key').value = '';
            document.getElementById('orderNum').value = '0';
            document.getElementById('rootPath').value = '';
            document.getElementById('s3Endpoint').value = '';
            document.getElementById('s3Bucket').value = '';
            document.getElementById('s3Ak').value = '';
            document.getElementById('s3Sk').value = '';

            // é»˜è®¤é€‰æœ¬åœ°
            document.getElementById('type').value = 'local';
            toggleTypeFields();
        }

        function hideForm() {
            document.getElementById('formArea').style.display = 'none';
        }

        // 4. ç¼–è¾‘å›æ˜¾
        function editStorage(id) {
            fetch('/api/admin/storage/info/' + id)
                .then(res => res.json())
                .then(res => {
                    const data = res.data;
                    showForm();
                    document.getElementById('formTitle').innerText = 'ç¼–è¾‘å­˜å‚¨æº';
                    document.getElementById('storageId').value = data.id;
                    document.getElementById('name').value = data.name;
                    document.getElementById('key').value = data.key;
                    document.getElementById('orderNum').value = data.orderNum;

                    // ä¸‹æ‹‰æ¡†èµ‹å€¼
                    // æ³¨æ„ï¼šåç«¯è¿”å›çš„ type æ˜¯æšä¸¾å¯¹è±¡ï¼Œå¯èƒ½å˜æˆäº† "ALIYUN" æˆ– "LOCAL"
                    // æˆ‘ä»¬çš„ option value æ˜¯ "aliyun" / "local"
                    // æ‰€ä»¥è¦åšä¸ªè½¬æ¢
                    let typeVal = (data.type.code || data.type).toLowerCase(); // å…¼å®¹ç›´æ¥è¿”å›å­—ç¬¦ä¸²æˆ–æšä¸¾å¯¹è±¡
                    document.getElementById('type').value = typeVal;

                    toggleTypeFields();

                    if (typeVal === 'local') {
                        document.getElementById('rootPath').value = data.rootPath;
                    } else {
                        // è§£æ JSON å¡«å……åˆ° S3 è¡¨å•
                        if (data.configData) {
                            try {
                                const conf = JSON.parse(data.configData);
                                document.getElementById('s3Endpoint').value = conf.endpoint || '';
                                document.getElementById('s3Bucket').value = conf.bucketName || '';
                                document.getElementById('s3Ak').value = conf.accessKey || '';
                                document.getElementById('s3Sk').value = conf.secretKey || '';
                            } catch (e) {
                                console.error("JSONè§£æå¤±è´¥", e);
                            }
                        }
                    }
                });
        }

        // 5. ä¿å­˜ (æ ¸å¿ƒé€»è¾‘ï¼šè‡ªåŠ¨æ‰“åŒ… JSON)
        function saveStorage() {
            const type = document.getElementById('type').value;

            const data = {
                id: document.getElementById('storageId').value || null,
                name: document.getElementById('name').value,
                key: document.getElementById('key').value,
                orderNum: document.getElementById('orderNum').value,
                type: type // ä¼ ç»™åç«¯ï¼Œåç«¯æšä¸¾ä¼šè‡ªåŠ¨åŒ¹é… "local" æˆ– "aliyun"
            };

            if (type === 'local') {
                data.rootPath = document.getElementById('rootPath').value;
                data.configData = ''; // æœ¬åœ°ä¸éœ€è¦ config
            } else {
                // S3: æ‰“åŒ…æˆ JSON
                const s3Config = {
                    endpoint: document.getElementById('s3Endpoint').value,
                    bucketName: document.getElementById('s3Bucket').value,
                    accessKey: document.getElementById('s3Ak').value,
                    secretKey: document.getElementById('s3Sk').value
                };
                data.configData = JSON.stringify(s3Config);
                data.rootPath = ''; // S3 ä¸éœ€è¦ rootPath
            }

            fetch('/api/admin/storage/save', {
                method: 'POST',
                body: JSON.stringify(data)
            }).then(res => res.json()).then(res => {
                if (res.code === 200) {
                    alert("ä¿å­˜æˆåŠŸ");
                    hideForm();
                    loadList();
                } else {
                    alert("ä¿å­˜å¤±è´¥ï¼š" + res.message);
                }
            });
        }

        function delStorage(id) {
            if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
            fetch('/api/admin/storage/delete/' + id, { method: 'DELETE' })
                .then(res => res.json())
                .then(res => {
                    if (res.code === 200) loadList();
                    else alert(res.message);
                });
        }
    </script>
    </body>
    </html>