<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„ç§äººç½‘ç›˜</title>
    <!-- å¼•å…¥ Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ GitHub é£æ ¼çš„ Markdown æ ·å¼ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f7fa; margin: 0; display: flex; flex-direction: column; height: 100vh; }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar { background: white; padding: 0 20px; height: 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; }
        .brand { font-size: 20px; font-weight: bold; color: #333; }
        .nav-links a { text-decoration: none; color: #666; margin-left: 20px; font-size: 14px; cursor: pointer; }
        .nav-links a:hover { color: #007bff; }

        /* ä¸»ä½“å¸ƒå±€ */
        .main-layout { display: flex; flex: 1; overflow: hidden; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 220px; background: white; border-right: 1px solid #eee; padding: 20px 0; overflow-y: auto; }
        .drive-item { padding: 12px 20px; cursor: pointer; color: #555; display: flex; align-items: center; }
        .drive-item:hover { background-color: #f0f7ff; color: #007bff; }
        .drive-item.active { background-color: #e6f2ff; color: #007bff; font-weight: 500; border-right: 3px solid #007bff; }
        .drive-icon { margin-right: 10px; }

        /* å†…å®¹åŒº */
        .content { flex: 1; padding: 20px; overflow-y: auto; }

        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .breadcrumb { padding: 10px; background: #eee; border-radius: 4px; margin-bottom: 20px; cursor: pointer; color: #007bff; }
        .file-list { list-style: none; padding: 0; }
        .file-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; transition: background 0.2s; cursor: pointer; }
        .file-item:hover { background-color: #f0f7ff; }
        .icon { margin-right: 10px; font-size: 20px; }
        .name { flex: 1; color: #333; font-weight: 500; }
        .size { color: #888; font-size: 14px; width: 80px; text-align: right; }
        .date { color: #aaa; font-size: 14px; width: 150px; text-align: right; margin-left: 20px; }
        .btn { padding: 5px 10px; cursor: pointer; border: none; border-radius: 4px; color: white; margin-left: 5px; }
        .btn-new { background-color: #28a745; }
        .btn-del { background-color: #dc3545; font-size: 12px; }
        .btn-edit { background-color: #ffc107; color: #333; margin-left: 10px; }
        .btn-edit:hover { background-color: #e0a800; }
        .toolbar { margin-bottom: 15px; display: flex; gap: 10px; }

        /* å¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { position: relative; background-color: #000; margin: auto; padding: 0; width: 80%; max-width: 1000px; text-align: center; }
        .close-btn { color: white; position: absolute; top: 10px; right: 25px; font-size: 35px; cursor: pointer; }
        #previewContainer img, #previewContainer video { max-width: 100%; max-height: 80vh; }

        /* Readme æ ·å¼ */
        .readme-box {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none; /* é»˜è®¤éšè— */
        }
    </style>
</head>
<body>

<!-- é¡¶éƒ¨ -->
<div class="navbar">
    <div class="brand">ğŸ“‚ ç®€æ˜“ç½‘ç›˜</div>
    <div class="nav-links">
        <a href="/admin">âš™ï¸ åå°ç®¡ç†</a>
        <a onclick="logout()">é€€å‡ºç™»å½•</a>
    </div>
</div>

<div class="main-layout">
    <!-- ä¾§è¾¹æ å­˜å‚¨æºåˆ—è¡¨ -->
    <div class="sidebar" id="driveList">
        <div style="padding:10px 20px; color:#999; font-size:12px">åŠ è½½å­˜å‚¨æº...</div>
    </div>

    <!-- å³ä¾§æ–‡ä»¶åŒº -->
    <div class="content">
        <div class="container">
            <!-- é¢åŒ…å±‘ -->
            <div class="breadcrumb" id="breadcrumb" onclick="loadFiles('/')">ğŸ  æ ¹ç›®å½•</div>

            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <button class="btn btn-new" onclick="createNewFolder()">+ æ–°å»ºæ–‡ä»¶å¤¹</button>
                <input type="file" id="uploadInput" style="display: none" onchange="doUpload()">
                <button class="btn btn-new" style="background-color: #007bff;" onclick="document.getElementById('uploadInput').click()">â˜ï¸ ä¸Šä¼ æ–‡ä»¶</button>
            </div>

            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <ul class="file-list" id="fileList">
                <li style="text-align:center; padding: 20px;">è¯·é€‰æ‹©å·¦ä¾§å­˜å‚¨æº</li>
            </ul>

            <!-- Readme æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="readmeContainer" class="readme-box markdown-body"></div>
        </div>
    </div>
</div>

<!-- é¢„è§ˆå¼¹çª— -->
<div id="previewModal" class="modal" onclick="closePreview()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closePreview()">&times;</span>
        <div id="previewContainer"></div>
    </div>
</div>

<script>
    // ================= å…¨å±€é…ç½® =================
    const TOKEN_KEY = 'satoken';
    let currentStorageKey = '';
    let currentPath = '/';
    const passwordCache = {}; // å¯†ç ç¼“å­˜

    // ================= æ‹¦æˆªå™¨é€»è¾‘ =================
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
        const token = localStorage.getItem(TOKEN_KEY);
        options = options || {};
        options.headers = options.headers || {};

        // è‡ªåŠ¨å¸¦ä¸Š Token
        if (token) {
            if (options.headers instanceof Headers) options.headers.append(TOKEN_KEY, token);
            else options.headers[TOKEN_KEY] = token;
        }

        return originalFetch(url, options).then(response => {
            if (response.status === 401) {
                localStorage.removeItem(TOKEN_KEY);
                location.href = '/login'; // è·³å›ç™»å½•é¡µ
                return Promise.reject("æœªç™»å½•");
            }
            return response;
        });
    };

    // ================= åˆå§‹åŒ–é€»è¾‘ =================
    window.onload = function() {
        if(!localStorage.getItem(TOKEN_KEY)) {
            location.href = '/login';
            return;
        }
        loadDrives(); // åŠ è½½ä¾§è¾¹æ 
    };

    // åŠ è½½ä¾§è¾¹æ å­˜å‚¨æº
    function loadDrives() {
        fetch('/api/storage/list')
            .then(res => res.json())
            .then(res => {
                // å¦‚æœåç«¯è¿”å›ç»“æ„æ˜¯ {code: 200, data: [...]}
                const drives = res.data || [];
                const sidebar = document.getElementById('driveList');
                sidebar.innerHTML = '';

                if (drives.length === 0) {
                    sidebar.innerHTML = '<div style="padding:20px">æš‚æ— å­˜å‚¨æº</div>';
                    return;
                }

                drives.forEach((drive, index) => {
                    const div = document.createElement('div');
                    div.className = 'drive-item';
                    div.innerHTML = `<span class="drive-icon">ğŸ’½</span> ${drive.name}`;
                    div.onclick = () => switchDrive(drive.key, div);
                    sidebar.appendChild(div);

                    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                    if (index === 0) {
                        switchDrive(drive.key, div);
                    }
                });
            })
            .catch(err => console.error("åŠ è½½å­˜å‚¨æºå¤±è´¥", err));
    }

    // åˆ‡æ¢å­˜å‚¨æº
    function switchDrive(key, element) {
        document.querySelectorAll('.drive-item').forEach(el => el.classList.remove('active'));
        if(element) element.classList.add('active');
        currentStorageKey = key;
        loadFiles('/'); // é‡æ–°åŠ è½½æ ¹ç›®å½•
    }

    // ================= æ ¸å¿ƒï¼šåŠ è½½æ–‡ä»¶åˆ—è¡¨ =================
    function loadFiles(path) {
        currentPath = path;
        document.getElementById('breadcrumb').innerText = 'ğŸ  æ ¹ç›®å½• ' + (path === '/' ? '' : path);

        const pwd = passwordCache[path] || '';
        const url = `/api/list?storageKey=${currentStorageKey}&path=${encodeURIComponent(path)}&password=${encodeURIComponent(pwd)}`;

        fetch(url)
            .then(res => res.json())
            .then(res => {
                if (res.code === 200) {
                    // æˆåŠŸï¼šæ¸²æŸ“åˆ—è¡¨ (res.data æ˜¯æ•°ç»„)
                    renderList(res.data || []);
                } else if (res.code === 403) {
                    // 403ï¼šéœ€è¦å¯†ç 
                    let inputPass = prompt("ğŸ”’ è¯¥æ–‡ä»¶å¤¹å·²åŠ å¯†ï¼Œè¯·è¾“å…¥å¯†ç ï¼š");
                    if (inputPass) {
                        passwordCache[path] = inputPass;
                        loadFiles(path); // é‡è¯•
                    } else {
                        // å–æ¶ˆåˆ™å›é€€
                        if (path !== '/') loadFiles('/');
                    }
                } else {
                    alert("åŠ è½½å¤±è´¥ï¼š" + res.message);
                }
            })
            .catch(err => console.error(err));
    }

    // æ¸²æŸ“åˆ—è¡¨åˆ°é¡µé¢
    function renderList(files) {
        // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœä¸æ˜¯æ•°ç»„ï¼Œå¼ºåˆ¶å˜ä¸ºç©ºæ•°ç»„
        if (!Array.isArray(files)) {
            console.warn("åç«¯è¿”å›çš„ä¸æ˜¯æ•°ç»„:", files);
            files = [];
        }

        const listElement = document.getElementById('fileList');
        const readmeContainer = document.getElementById('readmeContainer');

        // æ¸…ç©ºæ—§å†…å®¹
        listElement.innerHTML = '';
        if(readmeContainer) {
            readmeContainer.style.display = 'none';
            readmeContainer.innerHTML = '';
        }

        // ç©ºæ–‡ä»¶å¤¹æç¤º
        if (files.length === 0) {
            listElement.innerHTML = '<li style="text-align:center; padding:20px; color:#999">ç©ºæ–‡ä»¶å¤¹</li>';
            return;
        }

        // è¿”å›ä¸Šä¸€çº§æŒ‰é’®
        if (currentPath !== '/') {
            const upLi = document.createElement('li');
            upLi.className = 'file-item';
            upLi.innerHTML = '<span class="icon">ğŸ”™</span><span class="name">.. (è¿”å›ä¸Šä¸€çº§)</span>';
            upLi.onclick = () => {
                let parentPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
                if (parentPath === '') parentPath = '/';
                loadFiles(parentPath);
            };
            listElement.appendChild(upLi);
        }

        // éå†å¹¶æ¸²æŸ“æ–‡ä»¶
        files.forEach(file => {
            const li = document.createElement('li');
            li.className = 'file-item';
            const icon = file.type === 'FOLDER' ? 'ğŸ“' : 'ğŸ“„';
            const sizeStr = file.type === 'FOLDER' ? '-' : formatSize(file.size);
            const dateStr = new Date(file.time).toLocaleString();

            // æ³¨æ„ï¼šç‚¹å‡»äº‹ä»¶ç»‘å®šåœ¨ div ä¸Šï¼Œè€Œä¸æ˜¯ li ä¸Š
            li.innerHTML = `
                <div style="flex: 1; display: flex; align-items: center; cursor: pointer;"
                     onclick="handleClick('${file.type}', '${escapeStr(file.path)}', '${escapeStr(file.url)}')">
                    <span class="icon">${icon}</span>
                    <span class="name">${file.name}</span>
                </div>
                <span class="size">${sizeStr}</span>
                <span class="date">${dateStr}</span>
                <button class="btn btn-edit" onclick="renameItem('${escapeStr(file.name)}')">é‡å‘½å</button>
                <button class="btn btn-del" onclick="deleteItem('${escapeStr(file.path)}')">åˆ é™¤</button>
            `;
            listElement.appendChild(li);
        });

        // å°è¯•åŠ è½½ Readme
        if (typeof marked !== 'undefined') {
            const readmeFile = files.find(f => f.name.toLowerCase() === 'readme.md');
            if (readmeFile) {
                loadReadme(readmeFile);
            }
        }
    }

    // ================= è¾…åŠ©å·¥å…·å‡½æ•° =================
    function escapeStr(str) { if (!str) return ''; return str.replace(/'/g, "\\'").replace(/\\/g, "\\\\"); }

    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // é¢„è§ˆ/ä¸‹è½½å¤„ç†
    function handleClick(type, path, url) {
        if (type === 'FOLDER') {
            loadFiles(path);
        } else {
            // ç»™ä¸‹è½½é“¾æ¥å¸¦ä¸Š Token å’Œ storageKey
            const token = localStorage.getItem(TOKEN_KEY);
            let safeUrl = url + (url.includes('?') ? '&' : '?');
            safeUrl += `storageKey=${currentStorageKey}&satoken=${token}`;

            const ext = path.split('.').pop().toLowerCase();
            const imgExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const videoExts = ['mp4', 'webm', 'ogg'];

            if (imgExts.includes(ext)) showPreview(`<img src="${safeUrl}">`);
            else if (videoExts.includes(ext)) showPreview(`<video controls autoplay><source src="${safeUrl}" type="video/${ext}"></video>`);
            else window.open(safeUrl);
        }
    }

    function showPreview(html) {
        document.getElementById('previewContainer').innerHTML = html;
        document.getElementById('previewModal').style.display = "flex";
    }

    function closePreview() {
        document.getElementById('previewModal').style.display = "none";
        document.getElementById('previewContainer').innerHTML = "";
    }

    document.addEventListener('keydown', function(event) { if (event.key === "Escape") closePreview(); });

    // ================= æ“ä½œé€»è¾‘ (æ–°å»º/åˆ é™¤/ä¸Šä¼ /æ³¨é”€) =================

    function createNewFolder() {
        let name = prompt("è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼š");
        if (!name) return;
        const url = `/api/mkdir?storageKey=${currentStorageKey}&path=${encodeURIComponent(currentPath)}&name=${encodeURIComponent(name)}`;
        fetch(url, { method: 'POST' }).then(res => res.text()).then(res => {
            if (res === 'success') loadFiles(currentPath);
            else alert("åˆ›å»ºå¤±è´¥");
        });
    }

    function deleteItem(path) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;
        const url = `/api/delete?storageKey=${currentStorageKey}&path=${encodeURIComponent(path)}`;
        fetch(url, { method: 'DELETE' }).then(res => res.text()).then(res => {
            if (res === 'success') loadFiles(currentPath);
            else alert("åˆ é™¤å¤±è´¥");
        });
    }

    function doUpload() {
        const input = document.getElementById('uploadInput');
        const file = input.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('path', currentPath);
        formData.append('file', file);
        formData.append('storageKey', currentStorageKey);

        const btn = document.querySelector('button[onclick*="uploadInput"]');
        btn.innerText = "â³ ä¸Šä¼ ä¸­..."; btn.disabled = true;

        fetch('/api/upload', { method: 'POST', body: formData })
            .then(res => res.text())
            .then(res => {
                if (res === 'success') { alert("ä¸Šä¼ æˆåŠŸ"); loadFiles(currentPath); }
                else alert("ä¸Šä¼ å¤±è´¥");
            })
            .finally(() => { btn.innerText = "â˜ï¸ ä¸Šä¼ æ–‡ä»¶"; btn.disabled = false; input.value = ''; });
    }

    function logout() {
        fetch('/api/logout', { method: 'POST' }).finally(() => {
            localStorage.removeItem(TOKEN_KEY);
            location.href = '/login';
        });
    }

    function loadReadme(file) {
        let url = `/api/download?storageKey=${currentStorageKey}&path=${encodeURIComponent(file.path)}`;
        fetch(url).then(res => res.text()).then(text => {
            const container = document.getElementById('readmeContainer');
            container.innerHTML = marked.parse(text);
            container.style.display = 'block';
        }).catch(err => console.error("ReadmeåŠ è½½å¤±è´¥", err));
    }

    function renameItem(oldName) {
        const newName = prompt("è¯·è¾“å…¥æ–°åç§°:", oldName);
        if (!newName || newName === oldName) return;

        const formData = new FormData();
        formData.append('storageKey', currentStorageKey);
        formData.append('path', currentPath);
        formData.append('name', oldName);
        formData.append('newName', newName);

        fetch('/api/rename', {
            method: 'POST',
            body: formData
        }).then(res => res.json()).then(res => {
            if (res.code === 200) {
                loadFiles(currentPath); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert(res.message || "é‡å‘½åå¤±è´¥");
            }
        });
    }
</script>
</body>
</html>